<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Scan Exercise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            flex-direction: column;
            padding: 1rem;
        }
        .container {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .body-container {
            position: relative;
            width: 100%;
            height: auto;
            max-width: 400px;
            margin: auto;
        }
        .body-part-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(34, 197, 94, 0.7); /* Green with transparency */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #feet-overlay {
            clip-path: polygon(42% 90%, 58% 90%, 58% 100%, 42% 100%);
        }
        #legs-overlay {
            clip-path: polygon(40% 60%, 60% 60%, 60% 90%, 40% 90%);
        }
        #torso-overlay {
            clip-path: polygon(30% 35%, 70% 35%, 70% 60%, 30% 60%);
        }
        #arms-overlay {
            clip-path: polygon(25% 45%, 75% 45%, 75% 55%, 25% 55%);
        }
        #head-overlay {
            clip-path: polygon(40% 10%, 60% 10%, 60% 35%, 40% 35%);
        }
        .body-part-overlay.active {
            opacity: 1;
        }
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .control-button {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            line-height: 1;
        }
        .control-button:hover {
            background-color: #1d4ed8;
        }
        .emoji {
            font-size: 20rem;
            line-height: 1;
        }
        #message {
            margin-top: 1rem;
            color: #4a5568;
            font-weight: bold;
        }
        #start-button {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #2563eb;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 4rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #start-button:hover {
            background-color: #1d4ed8;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading-screen">
            <div id="message">Loading audio... please wait.</div>
        </div>
        <div id="start-screen" class="hidden">
            <div id="start-button">‚ñ∂Ô∏é</div>
        </div>
        <div id="body-scan-area" class="hidden">
            <div class="body-container">
                <span class="emoji" role="img" aria-label="human figure">üßç</span>
                <div id="feet-overlay" class="body-part-overlay"></div>
                <div id="legs-overlay" class="body-part-overlay"></div>
                <div id="torso-overlay" class="body-part-overlay"></div>
                <div id="arms-overlay" class="body-part-overlay"></div>
                <div id="head-overlay" class="body-part-overlay"></div>
            </div>
            <div class="controls">
                <button id="play-pause-button" class="control-button">‚ñ∂Ô∏é</button>
                <button id="back-button" class="control-button">‚èÆÔ∏è</button>
                <button id="restart-button" class="control-button">üîÑ</button>
            </div>
        </div>
    </div>

    <script>
        // Helper function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM audio to a WAV Blob
        function pcmToWav(pcmData, sampleRate) {
            const dataLength = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // WAV header
            let offset = 0;
            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            }
            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }
            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            writeString('RIFF');
            writeUint32(36 + dataLength);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16); // subchunk1 size
            writeUint16(1); // audio format (1 = PCM)
            writeUint16(1); // num channels
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2); // byte rate
            writeUint16(2); // block align
            writeUint16(16); // bits per sample
            writeString('data');
            writeUint32(dataLength);

            // Write PCM data
            const pcm16 = new Int16Array(pcmData);
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // Function to call the TTS API and get the audio blob
        async function getAudioBlob(text) {
            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    return pcmToWav(pcm16, sampleRate);
                } else {
                    console.error('Failed to get audio data from API response.');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching audio:', error);
                return null;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const startScreen = document.getElementById('start-screen');
            const startButton = document.getElementById('start-button');
            const bodyScanArea = document.getElementById('body-scan-area');
            const loadingScreen = document.getElementById('loading-screen');
            const playPauseButton = document.getElementById('play-pause-button');
            const restartButton = document.getElementById('restart-button');
            const backButton = document.getElementById('back-button');
            
            let audioCache = {};
            let currentPartIndex = 0;
            let currentAudio = null;
            let isPlaying = false;
            let timeoutId = null;

            const bodyParts = [
                { id: 'feet-overlay', prompt: 'Let‚Äôs begin our body scan. Take a deep breath and start by focusing on your feet.' },
                { id: 'legs-overlay', prompt: 'Now, move your attention up to your legs. What do you notice here?' },
                { id: 'torso-overlay', prompt: 'Next, bring your attention to your torso. How does your stomach and chest feel?' },
                { id: 'arms-overlay', prompt: 'Shift your focus to your arms and hands. What do you feel here?' },
                { id: 'head-overlay', prompt: 'Finally, bring your focus to your head and face. What do you feel with your eyes, ears, and nose?' },
                { id: null, prompt: 'The body scan is now complete. You can end your practice here, or just sit quietly for a moment, noticing how you feel.'}
            ];
            
            const highlightPart = (index) => {
                document.querySelectorAll('.body-part-overlay').forEach(overlay => overlay.classList.remove('active'));
                if (index >= 0 && index < bodyParts.length) {
                    const currentPart = bodyParts[index].id ? document.getElementById(bodyParts[index].id) : null;
                    if (currentPart) {
                        currentPart.classList.add('active');
                    }
                }
            };
            
            const runScanSequence = () => {
                if (!isPlaying || currentPartIndex >= bodyParts.length) {
                    highlightPart(-1);
                    playPauseButton.textContent = "‚ñ∂Ô∏é";
                    isPlaying = false;
                    return;
                }

                highlightPart(currentPartIndex);
                
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                
                currentAudio = audioCache[currentPartIndex];
                
                if (currentAudio) {
                    playPauseButton.textContent = "‚è∏Ô∏è";
                    currentAudio.play();
                    currentAudio.onended = () => {
                        timeoutId = setTimeout(() => {
                            currentPartIndex++;
                            runScanSequence();
                        }, 10000);
                    };
                } else {
                    // Fallback to move to the next part if audio fails to load
                    timeoutId = setTimeout(() => {
                        currentPartIndex++;
                        runScanSequence();
                    }, 10000);
                }
            };

            const preloadAudio = async () => {
                loadingScreen.classList.remove('hidden');
                const promises = bodyParts.map(part => getAudioBlob(part.prompt));
                const blobs = await Promise.all(promises);
                blobs.forEach((blob, index) => {
                    if (blob) {
                        const audioUrl = URL.createObjectURL(blob);
                        audioCache[index] = new Audio(audioUrl);
                    }
                });
                loadingScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            };
            
            startButton.addEventListener('click', () => {
                startScreen.classList.add('hidden');
                bodyScanArea.classList.remove('hidden');
                isPlaying = true;
                runScanSequence();
            });

            playPauseButton.addEventListener('click', () => {
                if (isPlaying) {
                    isPlaying = false;
                    playPauseButton.textContent = "‚ñ∂Ô∏é";
                    clearTimeout(timeoutId);
                    if (currentAudio) {
                        currentAudio.pause();
                    }
                } else {
                    isPlaying = true;
                    playPauseButton.textContent = "‚è∏Ô∏è";
                    if (currentAudio && currentAudio.paused) {
                        currentAudio.play();
                    } else {
                        runScanSequence();
                    }
                }
            });

            backButton.addEventListener('click', () => {
                isPlaying = true;
                clearTimeout(timeoutId);
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                currentPartIndex = Math.max(0, currentPartIndex - 1);
                runScanSequence();
            });

            restartButton.addEventListener('click', () => {
                isPlaying = true;
                clearTimeout(timeoutId);
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                currentPartIndex = 0;
                runScanSequence();
            });

            preloadAudio();
        });
    </script>

</body>
</html>

