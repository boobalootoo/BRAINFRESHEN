<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Butterfly Mask Camera</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet">
<style>
  html,body {height:100%;margin:0;background:#0f172a;color:#e6eef8;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .stage{position:relative;max-width:900px;margin:1.5rem auto}
  video, canvas {width:100%;height:auto;display:block}
  .stack{position:relative;aspect-ratio:4/3;overflow:hidden;border-radius:12px;}
  .stack canvas, .stack video{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:cover}
  #frozenCanvas{pointer-events:none}
</style>
</head>
<body>
<div class="stage p-4">
  <h1 class="text-2xl mb-2">Butterfly Mask Camera</h1>
  <p class="text-sm mb-4">Press <strong>Capture</strong> â€” the area inside the butterfly image will be frozen while the surrounding camera remains live.</p>

  <div class="stack bg-black" id="preview">
    <video id="video" autoplay playsinline></video>
    <canvas id="liveCanvas"></canvas>
    <canvas id="frozenCanvas"></canvas>
    <!-- Butterfly mask image overlay -->
    <img id="butterflyMask" src="https://raw.githubusercontent.com/boobalootoo/BRAINFRESHEN/main/BUTTERFLIND/butterfly.png" alt="butterfly mask" style="position:absolute;left:0;top:0;width:100%;height:100%;object-fit:contain;pointer-events:none;opacity:0.3;">
  </div>

  <div class="controls mt-3 flex gap-2 flex-wrap">
    <button id="captureBtn" class="px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-600">Capture</button>
    <button id="clearBtn" class="px-4 py-2 rounded bg-slate-600 hover:bg-slate-700">Clear</button>
    <button id="downloadButterfly" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700">Download butterfly PNG</button>
    <button id="downloadFrame" class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-700">Download full frame PNG</button>
  </div>

  <p class="mt-3 text-xs text-slate-400">Tip: use "Download butterfly PNG" to export the masked portion (transparent background).</p>
</div>

<script>
const video = document.getElementById('video');
const liveCanvas = document.getElementById('liveCanvas');
const frozenCanvas = document.getElementById('frozenCanvas');
const butterflyMask = document.getElementById('butterflyMask');

let liveCtx, frozenCtx;
let streaming = false;
let frozen = false;
let maskImage = new Image();
maskImage.crossOrigin = "anonymous";
maskImage.src = butterflyMask.src;

function setCanvasSizes(width, height){
  [liveCanvas,frozenCanvas].forEach(c=>{c.width = width; c.height = height;});
}

async function startCamera(){
  try{
    const constraints = {video: { facingMode: { exact: 'environment' } }, audio: false};
    let stream;
    try{ stream = await navigator.mediaDevices.getUserMedia(constraints); }
    catch(e){ stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false}); }
    video.srcObject = stream;
    await video.play();
    streaming = true;
    const track = stream.getVideoTracks()[0];
    const settings = track.getSettings();
    const w = video.videoWidth || settings.width || 1280;
    const h = video.videoHeight || settings.height || 720;
    setCanvasSizes(w,h);
    liveCtx = liveCanvas.getContext('2d');
    frozenCtx = frozenCanvas.getContext('2d');
    requestAnimationFrame(loop);
  }catch(err){
    alert('Could not access camera: '+err.message);
  }
}

function loop(){
  if(!streaming) return;
  liveCtx.clearRect(0,0,liveCanvas.width, liveCanvas.height);
  liveCtx.drawImage(video,0,0, liveCanvas.width, liveCanvas.height);
  requestAnimationFrame(loop);
}

function captureFrame(){
  if(!streaming || !maskImage.complete) return;
  const w = liveCanvas.width, h = liveCanvas.height;
  const tmp = document.createElement('canvas'); tmp.width=w; tmp.height=h; const tctx=tmp.getContext('2d');
  tctx.drawImage(video,0,0,w,h);

  frozenCtx.clearRect(0,0,w,h);

  // draw mask
  frozenCtx.save();
  frozenCtx.drawImage(maskImage,0,0,w,h);
  frozenCtx.globalCompositeOperation = 'source-in';
  frozenCtx.drawImage(tmp,0,0,w,h);
  frozenCtx.restore();

  frozen = true;
}

function clearFrozen(){
  if(!frozen) return;
  frozenCtx.clearRect(0,0,frozenCanvas.width,frozenCanvas.height);
  frozen = false;
}

function downloadCanvas(canvas, filename){
  canvas.toBlob(function(blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });
}

document.getElementById('captureBtn').addEventListener('click', ()=>{ captureFrame(); if(navigator.vibrate) navigator.vibrate(40); });
document.getElementById('clearBtn').addEventListener('click', clearFrozen);
document.getElementById('downloadButterfly').addEventListener('click', ()=>{
  if(!frozen){ alert('No captured butterfly to download.'); return; }
  downloadCanvas(frozenCanvas,'butterfly.png');
});
document.getElementById('downloadFrame').addEventListener('click', ()=>{
  const w = liveCanvas.width, h = liveCanvas.height;
  const tmp = document.createElement('canvas'); tmp.width=w; tmp.height=h; const tctx=tmp.getContext('2d');
  tctx.drawImage(video,0,0,w,h);
  downloadCanvas(tmp,'frame.png');
});

startCamera();
</script>
</body>
</html>
