<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Paged Text Editor</title>
</head>
<body>
  <h1>Upload Text</h1>
  <input type="file" id="fileInput" accept=".txt">
  <button id="downloadBtn">Download .html Book</button>
  <div id="pages"></div>

  <script>
    let pages = [];

    function renderPages() {
      const container = document.getElementById("pages");
      container.innerHTML = "";

      pages.forEach((page, index) => {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "flex-start";
        row.style.marginBottom = "10px";
        row.style.gap = "10px";

        const label = document.createElement("div");
        label.textContent = "Page " + (index + 1);
        label.style.width = "60px";
        label.style.fontWeight = "bold";
        label.style.marginTop = "6px";

        const textarea = document.createElement("textarea");
        textarea.value = page.text || "";
        textarea.rows = 10;
        textarea.cols = 50;
        textarea.addEventListener("input", () => {
          page.text = textarea.value;
        });

        const controls = document.createElement("div");

        const insertBtn = document.createElement("button");
        insertBtn.textContent = "+ Insert Below";
        insertBtn.onclick = () => {
          pages.splice(index + 1, 0, { text: "", media: null });
          renderPages();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "ðŸ—‘ Delete";
        deleteBtn.onclick = () => {
          pages.splice(index, 1);
          renderPages();
        };

        const mediaInput = document.createElement("input");
        mediaInput.type = "file";
        mediaInput.accept = "image/*,video/*";
        mediaInput.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function(event) {
            page.media = { type: file.type, data: event.target.result };
            renderPages();
          };
          reader.readAsDataURL(file);
        };

        controls.appendChild(insertBtn);
        controls.appendChild(deleteBtn);
        controls.appendChild(mediaInput);

        const contentColumn = document.createElement("div");
        contentColumn.appendChild(textarea);

        if (page.media) {
          const media = document.createElement(page.media.type.startsWith("video") ? "video" : "img");
          if (page.media.type.startsWith("video")) {
            media.controls = true;
            media.width = 200;
          } else {
            media.style.maxWidth = "200px";
            media.style.display = "block";
            media.style.marginTop = "10px";
          }
          media.src = page.media.data;
          contentColumn.appendChild(media);
        }

        row.appendChild(label);
        row.appendChild(contentColumn);
        row.appendChild(controls);
        container.appendChild(row);
      });
    }

    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const text = event.target.result;
        pages = text.split(/---PAGEBREAK---/i).map(p => ({ text: p.trim(), media: null }));
        renderPages();
      };
      reader.readAsText(file);
    });

    document.getElementById("downloadBtn").addEventListener("click", function() {
      const htmlParts = pages.map((page, index) => {
        const content = `
          <div class="book-page">
            <h2>Page ${index + 1}</h2>
            <div class="text">${page.text.replace(/\n/g, "<br>")}</div>
            ${
              page.media
                ? page.media.type.startsWith("video")
                  ? `<video controls width="300" src="${page.media.data}"></video>`
                  : `<img src="${page.media.data}" style="max-width:300px; margin-top:10px;">`
                : ""
            }
          </div>
        `;
        return content;
      }).join("\n");

      const fullHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>My Book</title>
  <style>
    body {
      font-family: Georgia, serif;
      background: #f0f0f0;
      padding: 20px;
      text-align: center;
    }
    .book-page {
      background: white;
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      page-break-after: always;
    }
    .text {
      text-align: left;
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>My Book</h1>
  ${htmlParts}
</body>
</html>`;

      const blob = new Blob([fullHTML], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "my-book.html";
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
