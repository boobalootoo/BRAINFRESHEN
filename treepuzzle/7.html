<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaf Puzzle</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
const treeNames = ['alder', 'ash', 'birch', 'chestnut', 'oak', 'pine', 'willow'];

const treeImages = {};
const leafImages = {};
const loadedImages = [];

let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Helper to load a single image
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

async function loadAllImages() {
  for (let name of treeNames) {
    treeImages[name] = await loadImage(`${name}.png`);
    leafImages[name] = await loadImage(`${name}leaf.png`);
  }
}

function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  window.speechSynthesis.speak(utterance);
}

let trees = [];
let leaves = [];
let draggingLeaf = null;
let offsetX = 0, offsetY = 0;
let mouseDownTime = 0;

function setupGame() {
  trees = [];
  leaves = [];

  const spacing = canvas.width / treeNames.length;
  treeNames.forEach((name, index) => {
    const img = treeImages[name];
    const leafImg = leafImages[name];

    const x = spacing * index + spacing / 2 - img.width / 2;
    const y = canvas.height / 2 - img.height / 2;

    // Cutout position and size
    const cutoutSize = Math.min(img.width, img.height) / 2;
    const cutoutX = x + img.width / 2 - cutoutSize / 2;
    const cutoutY = y + img.height / 2 - cutoutSize / 2;

    trees.push({ name, img, x, y, cutoutX, cutoutY, cutoutSize });

    leaves.push({
      name,
      img: leafImg,
      x: 50 + Math.random() * 100,
      y: 50 + Math.random() * 100,
      width: cutoutSize,
      height: cutoutSize,
      dragging: false
    });
  });

  drawScene();
}

function drawScene() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  trees.forEach(tree => {
    // Draw tree image
    ctx.drawImage(tree.img, tree.x, tree.y);

    // Draw cutout (using destination-out to make a hole)
    ctx.save();
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(tree.cutoutX + tree.cutoutSize / 2, tree.cutoutY + tree.cutoutSize / 2, tree.cutoutSize / 2, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  });

  // Draw draggable leaves
  leaves.forEach(leaf => {
    ctx.drawImage(leaf.img, leaf.x, leaf.y, leaf.width, leaf.height);
  });
}

// Mouse Events
canvas.addEventListener('mousedown', (e) => {
  const mx = e.clientX;
  const my = e.clientY;
  mouseDownTime = Date.now();

  // Check if clicking a leaf
  for (let leaf of leaves) {
    if (
      mx >= leaf.x && mx <= leaf.x + leaf.width &&
      my >= leaf.y && my <= leaf.y + leaf.height
    ) {
      draggingLeaf = leaf;
      offsetX = mx - leaf.x;
      offsetY = my - leaf.y;
      leaf.dragging = true;
      return;
    }
  }
});

canvas.addEventListener('mouseup', (e) => {
  const mx = e.clientX;
  const my = e.clientY;
  const clickDuration = Date.now() - mouseDownTime;

  if (draggingLeaf) {
    draggingLeaf.dragging = false;

    // Check if dropped into correct cutout
    for (let tree of trees) {
      if (
        tree.name === draggingLeaf.name &&
        mx >= tree.cutoutX && mx <= tree.cutoutX + tree.cutoutSize &&
        my >= tree.cutoutY && my <= tree.cutoutY + tree.cutoutSize
      ) {
        // Snap into place
        draggingLeaf.x = tree.cutoutX;
        draggingLeaf.y = tree.cutoutY;
      }
    }

    draggingLeaf = null;
    drawScene();
  } else if (clickDuration < 200) {
    // Check if clicked on a tree
    for (let tree of trees) {
      if (
        mx >= tree.x && mx <= tree.x + tree.img.width &&
        my >= tree.y && my <= tree.y + tree.img.height
      ) {
        speak(tree.name);
        break;
      }
    }
  }
});

canvas.addEventListener('mousemove', (e) => {
  if (draggingLeaf) {
    draggingLeaf.x = e.clientX - offsetX;
    draggingLeaf.y = e.clientY - offsetY;
    drawScene();
  }
});

loadAllImages().then(() => {
  setupGame();
});
</script>
</body>
</html>
