<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Leaf Puzzle</title>
    <!-- Use Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef5e9;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            max-width: 960px;
            max-height: 80vh;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
            border: 2px solid #ddd;
        }
        .controls-container {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
    </style>
</head>
<body class="p-4">

    <h1 class="text-4xl font-extrabold text-green-800 tracking-tight mb-4 text-center">Tree Leaf Puzzle</h1>
    <p class="text-lg text-gray-600 mb-6 text-center">Match the leaves to the correct trees!</p>

    <!-- Main Game Canvas -->
    <canvas id="puzzleCanvas"></canvas>
    
    <!-- Modal for win message -->
    <div id="win-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
            <h2 class="text-3xl font-bold text-green-700 mb-4">You Did It!</h2>
            <p class="text-xl text-gray-700 mb-6">All leaves are in place. Great job!</p>
            <button id="restart-button" class="px-8 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full transition-transform transform hover:scale-105">
                Play Again
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('puzzleCanvas');
        const ctx = canvas.getContext('2d');
        const winModal = document.getElementById('win-modal');
        const restartButton = document.getElementById('restart-button');

        const treeData = [
            { name: 'oak', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/oak.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/oakleaf.png' },
            { name: 'pine', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/pine.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/pineleaf.png' },
            { name: 'willow', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/willow.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/willowleaf.png' },
            { name: 'alder', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/alder.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/alderleaf.png' },
            { name: 'ash', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/ash.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/ashleaf.png' },
            { name: 'birch', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/birch.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/birchleaf.png' },
            { name: 'chestnut', treeUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/chestnut.png', leafUrl: 'https://boobalootoo.github.io/BRAINFRESHEN/treepuzzle/chestnutleaf.png' },
        ];

        let images = {};
        let loadedImages = 0;
        let totalImagesToLoad = 0;

        let treeSprites = [];
        let leafSprites = [];
        let dragging = null;
        let offsetX = 0;
        let offsetY = 0;
        let isSolved = {};
        
        function resizeCanvas() {
            canvas.width = window.innerWidth > 960 ? 960 : window.innerWidth * 0.9;
            canvas.height = window.innerHeight * 0.7;
            if (images.oak && images.oakleaf) {
                positionSprites();
                draw();
            }
        }

        function positionSprites() {
            treeSprites = [];
            leafSprites = [];
            const treeCols = 4;
            const treeSpacingX = canvas.width / treeCols;
            const treeSpacingY = canvas.height * 0.5;

            // Use the shuffled order to place trees and leaves
            const shuffledTrees = [...treeData].sort(() => Math.random() - 0.5);

            shuffledTrees.forEach((tree, index) => {
                isSolved[tree.name] = false;
                
                const x = treeSpacingX * (index % treeCols) + (treeSpacingX / 2) - 100;
                const y = treeSpacingY * Math.floor(index / treeCols) + 50;
                const treeWidth = 200;
                const treeHeight = 200;
                const leafWidth = 80;
                const leafHeight = 80;

                // Tree sprite with cutout
                treeSprites.push({ 
                    name: tree.name, 
                    x, y, 
                    img: images[tree.name], 
                    leaf: images[`${tree.name}leaf`], 
                    width: treeWidth, 
                    height: treeHeight 
                });

                // Place draggable leaves randomly at the bottom.
                const leafX = Math.random() * (canvas.width - leafWidth);
                const leafY = canvas.height - leafHeight - 20;

                leafSprites.push({ 
                    name: tree.name, 
                    x: leafX, 
                    y: leafY, 
                    img: images[`${tree.name}leaf`], 
                    width: leafWidth, 
                    height: leafHeight 
                });
            });
            
            // Re-order the leaves to prevent overlap
            leafSprites.sort(() => Math.random() - 0.5);
            let currentX = 20;
            let currentY = canvas.height - 100;
            const padding = 10;
            leafSprites.forEach(leaf => {
                if (currentX + leaf.width > canvas.width - 20) {
                    currentX = 20;
                    currentY += leaf.height + padding;
                }
                leaf.x = currentX;
                leaf.y = currentY;
                currentX += leaf.width + padding;
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            treeSprites.forEach(sprite => {
                ctx.save();
                ctx.drawImage(sprite.img, sprite.x, sprite.y, sprite.width, sprite.height);

                // Create the cutout using 'destination-out'
                ctx.globalCompositeOperation = 'destination-out';
                const cutoutW = sprite.width / 2;
                const cutoutH = sprite.height / 2;
                const cutoutX = sprite.x + (sprite.width - cutoutW) / 2;
                const cutoutY = sprite.y + (sprite.height - cutoutH) / 2;
                ctx.drawImage(sprite.leaf, cutoutX, cutoutY, cutoutW, cutoutH);
                ctx.restore();
            });

            leafSprites.forEach(leaf => {
                // If the leaf is solved, draw it into the cutout.
                if (isSolved[leaf.name]) {
                     const tree = treeSprites.find(t => t.name === leaf.name);
                     const cutoutW = tree.width / 2;
                     const cutoutH = tree.height / 2;
                     const cutoutX = tree.x + (tree.width - cutoutW) / 2;
                     const cutoutY = tree.y + (tree.height - cutoutH) / 2;
                     ctx.drawImage(leaf.img, cutoutX, cutoutY, cutoutW, cutoutH);
                } else {
                    ctx.drawImage(leaf.img, leaf.x, leaf.y, leaf.width, leaf.height);
                }
            });
        }
        
        // --- FIX START ---
        // Helper to get coordinates relative to the canvas
        function getCanvasLocation(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function handleDragStart(e) {
            e.preventDefault();
            const { x, y } = getCanvasLocation(e);

            // Find the leaf being clicked
            for (let i = leafSprites.length - 1; i >= 0; i--) {
                const leaf = leafSprites[i];
                if (!isSolved[leaf.name] && 
                    x > leaf.x && x < leaf.x + leaf.width &&
                    y > leaf.y && y < leaf.y + leaf.height
                ) {
                    dragging = leaf;
                    offsetX = x - leaf.x;
                    offsetY = y - leaf.y;

                    // Move the dragging leaf to the end of the array to draw on top
                    leafSprites.splice(i, 1);
                    leafSprites.push(dragging);
                    return;
                }
            }
        }

        function handleDrag(e) {
            if (!dragging) return;
            e.preventDefault();
            const { x, y } = getCanvasLocation(e);
            
            dragging.x = x - offsetX;
            dragging.y = y - offsetY;
            draw();
        }

        function handleDragEnd(e) {
            if (!dragging) return;
            
            const tree = treeSprites.find(t => t.name === dragging.name);
            const cutoutW = tree.width / 2;
            const cutoutH = tree.height / 2;
            const cutoutX = tree.x + (tree.width - cutoutW) / 2;
            const cutoutY = tree.y + (tree.height - cutoutH) / 2;

            // Check if the leaf is dropped in the correct cutout
            if (
                dragging.x + dragging.width / 2 > cutoutX &&
                dragging.x + dragging.width / 2 < cutoutX + cutoutW &&
                dragging.y + dragging.height / 2 > cutoutY &&
                dragging.y + dragging.height / 2 < cutoutY + cutoutH
            ) {
                isSolved[dragging.name] = true;
                
                try {
                    const utterance = new SpeechSynthesisUtterance(dragging.name);
                    speechSynthesis.speak(utterance);
                } catch (err) {
                    console.error("Speech synthesis failed:", err);
                }

                checkWinCondition();
            }

            dragging = null;
            draw();
        }

        // --- FIX END ---

        function checkWinCondition() {
            const allSolved = Object.values(isSolved).every(status => status === true);
            if (allSolved) {
                winModal.classList.remove('hidden');
            }
        }

        function preloadImages() {
            totalImagesToLoad = treeData.length * 2;
            treeData.forEach(tree => {
                images[tree.name] = new Image();
                images[tree.name].src = tree.treeUrl;
                images[tree.name].onload = checkLoaded;
                images[tree.name].onerror = () => { console.error(`Failed to load: ${tree.treeUrl}`); checkLoaded(); };

                images[`${tree.name}leaf`] = new Image();
                images[`${tree.name}leaf`].src = tree.leafUrl;
                images[`${tree.name}leaf`].onload = checkLoaded;
                images[`${tree.name}leaf`].onerror = () => { console.error(`Failed to load: ${tree.leafUrl}`); checkLoaded(); };
            });
        }

        function checkLoaded() {
            loadedImages++;
            if (loadedImages === totalImagesToLoad) {
                initGame();
            }
        }

        function initGame() {
            winModal.classList.add('hidden');
            resizeCanvas();
        }

        // Event listeners
        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('mousedown', handleDragStart);
        canvas.addEventListener('touchstart', handleDragStart);
        canvas.addEventListener('mousemove', handleDrag);
        canvas.addEventListener('touchmove', handleDrag);
        canvas.addEventListener('mouseup', handleDragEnd);
        canvas.addEventListener('touchend', handleDragEnd);
        restartButton.addEventListener('click', initGame);

        // Start the game by preloading images
        preloadImages();
    </script>
</body>
</html>
